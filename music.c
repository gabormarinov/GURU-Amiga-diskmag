/*****************************************************************

Program:	Music.c

			A GURU lemezújság zene modulja.
			
Szerzõk:	Marinov Gábor	<<Gaborca>>
			Plósz Tamás		<<Poko>>

Dátum:		1990.10.12.

Utolsó
módosítás:	1990.10.12

******************************************************************/

#include <exec/types.h>
#include <exec/interrupts.h>
#include <intuition/intuition.h>
#include <functions.h>

#define MUSIC_PLAYER_SIZE 0x09ec
#define	T_MUSIC		6				/*  Zenemodul				*/

extern	BOOL	LoadFile();
extern	char	*FileAddr;
extern	long	FileSize;

extern struct Gadget Gadget8;
extern struct Image  icon[];
extern struct Window *BottomWindow;


char	ModulName[35];
char	*MusicAddr = NULL;
long	MusicSize  = 0;
BOOL	PlayMusic	= FALSE;
BOOL	IsMusicInMemory = FALSE;

UWORD	server[] =
{
	0x0000,0x0000,0x0000,0x0000,0x020A,0x0000,0x0050,0x0000,
	0x0020,0x0000,0x0078,0x08FA,0x08FC,0x08F8,0x08F6,0x09EC,
	0x0000,0x0000,0x0000,0x0000,0x0101,0x00FF,0x0100,0x0000,
	0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
	0x0000,0x0000,0x4E71,0x4E75,0x6000,0x0096,0x6000,0x01AA,
	0x496E,0x7475,0x6954,0x7261,0x636B,0x6572,0x0000,0x0000,
	0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
	0x0000,0xFFFF,0xFFFF,0x0000,0x7000,0x4E71,0x48E7,0x7FFE,
	0x6100,0x01AE,0x4CDF,0x7FFE,0x7000,0x4E75,0x103A,0xFF9E,
	0x671A,0x2C79,0x0000,0x0004,0x207A,0xFF94,0x43FA,0xFFC0,
	0x4EAE,0xFE92,0x41FA,0xFF86,0x10BC,0x0000,0x4E75,0x6100,
	0x0148,0x2C79,0x0000,0x0004,0x203C,0x0000,0x0005,0x43FA,
	0xFF40,0x4EAE,0xFF52,0x2C79,0x0000,0x0004,0x43FA,0xFF32,
	0x203A,0xFF4E,0x4EAE,0xFF2E,0x4E75,0x0000,0x0000,0x0000,
	0x49FA,0xFF98,0x38BA,0xFF5E,0x49FA,0xFF48,0x38BC,0x01E0,
	0x47FA,0xFF0E,0x2A4B,0xDBED,0x0020,0x41FA,0x08F0,0x2248,
	0xD2FC,0x01D8,0x707F,0x7200,0x0C29,0x0078,0xFFFF,0x660C,
	0x38BC,0x0000,0x5240,0x197C,0x0001,0xFFFB,0xD2FA,0xFF14,
	0x2401,0x5340,0x1219,0xB202,0x6EF6,0x51C8,0xFFF8,0x5202,
	0x2C7C,0xABBA,0xABBA,0x7A02,0x43FA,0x07C6,0xE182,0xE582,
	0x0682,0x0000,0x0258,0x7000,0x303A,0xFEE8,0xD480,0xD488,
	0x2442,0x700E,0x7200,0x323A,0xFEDA,0x6702,0x701E,0xB5CB,
	0x6D00,0x0084,0xB5CD,0x6C7E,0x4292,0x2C4A,0x22CA,0x7200,
	0x3228,0x002A,0xE381,0xD5C1,0xD1FC,0x0000,0x001E,0x51C8,
	0xFFDE,0x0039,0x0002,0x00DF,0xE001,0x4279,0x00DF,0xF0A8,
	0x4279,0x00DF,0xF0B8,0x4279,0x00DF,0xF0C8,0x4279,0x00DF,
	0xF0D8,0x33FC,0x000F,0x00DF,0xF096,0x49FA,0xFF34,0x197C,
	0x0006,0x0816,0x197C,0x0006,0x0817,0x422C,0x081A,0x422C,
	0x081B,0x426C,0x0818,0x42AC,0xFF58,0x42AC,0xFF5C,0x203C,
	0x0000,0x090C,0x0640,0x01D6,0xD07A,0xFE58,0x1974,0x0000,
	0x081C,0x7001,0x4E75,0xBDFC,0xABBA,0xABBA,0x6706,0x244E,
	0x51CD,0xFF7A,0x7000,0x4E75,0x4279,0x00DF,0xF0A8,0x4279,
	0x00DF,0xF0B8,0x4279,0x00DF,0xF0C8,0x4279,0x00DF,0xF0D8,
	0x33FC,0x000F,0x00DF,0xF096,0x49FA,0xFE60,0x38BA,0xFE28,
	0x7000,0x49FA,0xFE1C,0x2880,0x49FA,0x06D0,0x1880,0x4E75,
	0x49FA,0xFEAE,0x41FA,0x07B6,0x522C,0x081B,0x103A,0x06BD,
	0x1200,0x0601,0x0001,0xB23A,0x06AE,0x670E,0xB03A,0x06A8,
	0x6D24,0x422C,0x081B,0x6000,0x00C8,0x203A,0xFDE4,0x67EC,
	0x5340,0x49FA,0xFD9C,0x297C,0x0000,0x0000,0x0040,0x1940,
	0x08FA,0x6000,0x02F0,0x4DFA,0xFDBC,0x2E0E,0x4DFA,0x06FE,
	0x4BF9,0x00DF,0xF0A0,0x6100,0x043A,0x4DFA,0xFDA9,0x2E0E,
	0x4DFA,0x0706,0x4BF9,0x00DF,0xF0B0,0x6100,0x0426,0x4DFA,
	0xFD96,0x2E0E,0x4DFA,0x070E,0x4BF9,0x00DF,0xF0C0,0x6100,
	0x0412,0x4DFA,0xFD83,0x2E0E,0x4DFA,0x0716,0x4BF9,0x00DF,
	0xF0D0,0x6100,0x03FE,0x6000,0x0304,0x7000,0x103A,0x062D,
	0x81FC,0x0003,0x4840,0x4A40,0x671C,0x0C40,0x0002,0x670A,
	0x7000,0x102E,0x0003,0xE808,0x6012,0x7000,0x102E,0x0003,
	0x0200,0x000F,0x6006,0x342E,0x0010,0x601E,0xE340,0x7200,
	0x322E,0x0010,0x41FA,0x05A4,0x7C24,0x3430,0x0000,0xB250,
	0x6C08,0x5448,0x51CE,0xFFF4,0x4E75,0x3B42,0x0006,0x4E75,
	0x41FA,0x06CA,0x2648,0x2448,0xD6FC,0x000C,0xD4FC,0x01D8,
	0xD4FA,0xFD00,0xD0FC,0x0258,0xD0FA,0xFCF8,0x303A,0xFCF4,
	0x6704,0xD0FC,0x0004,0x7000,0x2200,0x103A,0x05AE,0x1232,
	0x0000,0xE181,0xE581,0xD27A,0x05A0,0x49FA,0xFD84,0x426C,
	0x081E,0x4BF9,0x00DF,0xF0A0,0x49FA,0xFCCE,0x4DFA,0xFCC6,
	0x2E0E,0x4DFA,0x0608,0x6146,0x4BF9,0x00DF,0xF0B0,0x49FA,
	0xFCBA,0x4DFA,0xFCB1,0x2E0E,0x4DFA,0x060E,0x6130,0x4BF9,
	0x00DF,0xF0C0,0x49FA,0xFCA6,0x4DFA,0xFC9C,0x2E0E,0x4DFA,
	0x0614,0x611A,0x4BF9,0x00DF,0xF0D0,0x49FA,0xFC92,0x4DFA,
	0xFC87,0x2E0E,0x4DFA,0x061A,0x6104,0x6000,0x012A,0x2CB0,
	0x1800,0x5881,0x7400,0x142E,0x0002,0x0202,0x00F0,0xE80A,
	0x1016,0x0200,0x00F0,0x8400,0x6700,0x00AC,0x7600,0x43FA,
	0x0520,0x2802,0x5382,0xE582,0xC8FC,0x001E,0x2D71,0x2800,
	0x0004,0x3D73,0x4800,0x0008,0x3D73,0x4802,0x0012,0x3633,
	0x4804,0x6758,0x242E,0x0004,0x103A,0xFC23,0x6636,0x1A03,
	0xE343,0xD483,0x2D42,0x000A,0x3033,0x4804,0xD073,0x4806,
	0xB06E,0x0008,0x6E0C,0x3D40,0x0008,0x3D73,0x4806,0x000E,
	0x603A,0x2F0C,0x49FA,0xFBF7,0x18BC,0x0001,0x285F,0x9483,
	0xE243,0x1605,0xD483,0x2D42,0x0004,0x2D42,0x000A,0x3D73,
	0x4806,0x0008,0x3D73,0x4806,0x000E,0x6010,0x242E,0x0004,
	0xD483,0x2D42,0x000A,0x3D73,0x4806,0x000E,0x3C2E,0x0012,
	0xCF8F,0x1E86,0xCF8F,0x5246,0x7A00,0x1A3A,0xFBAF,0xCCC5,
	0xE08E,0x3B46,0x0008,0x3016,0x0240,0x0FFF,0x3880,0x6700,
	0x0342,0x102E,0x0002,0x0200,0x000F,0x0C00,0x0003,0x6608,
	0x6100,0x0136,0x6000,0x032C,0x3D56,0x0010,0x026E,0x0FFF,
	0x0010,0x302E,0x0014,0x33C0,0x00DF,0xF096,0x422E,0x001B,
	0x2AAE,0x0004,0x3B6E,0x0008,0x0004,0x302E,0x0010,0x0240,
	0x0FFF,0x3B40,0x0006,0x302E,0x0014,0x49FA,0xFC04,0x816C,
	0x081E,0x6000,0x02EE,0x303C,0x012C,0x51C8,0xFFFE,0x303A,
	0x040E,0x0040,0x8000,0x33C0,0x00DF,0xF096,0x303C,0x012C,
	0x51C8,0xFFFE,0x4BF9,0x00DF,0xF000,0x4DFA,0x04C4,0x2B6E,
	0x000A,0x00D0,0x3B6E,0x000E,0x00D4,0x4DFA,0x0498,0x2B6E,
	0x000A,0x00C0,0x3B6E,0x000E,0x00C4,0x4DFA,0x046C,0x2B6E,
	0x000A,0x00B0,0x3B6E,0x000E,0x00B4,0x4DFA,0x0440,0x2B6E,
	0x000A,0x00A0,0x3B6E,0x000E,0x00A4,0x49FA,0xFB94,0x066C,
	0x0010,0x0818,0x0C6C,0x0400,0x0818,0x6670,0x49FA,0xFB82,
	0x522C,0x081A,0x49FA,0xFB7A,0x426C,0x0818,0x422C,0x081D,
	0x022C,0x007F,0x081A,0x4A2C,0xFFFE,0x660E,0x123A,0x037C,
	0xB23A,0x037A,0x662A,0x422C,0x081A,0x197C,0x0000,0xFFFE,
	0x103A,0xFA97,0x661A,0x103A,0xFA90,0x6700,0xFB12,0x6100,
	0xFC58,0x49FA,0xFACE,0x28BC,0xFFFF,0xFFFF,0x6000,0xFAFE,
	0x103A,0xFA76,0x6716,0x297C,0xFFFF,0xFFFE,0xFF92,0x7000,
	0x103A,0x0338,0x3940,0xFF96,0x6100,0xFAE2,0x49FA,0xFB12,
	0x4A2C,0x081D,0x6686,0x4E75,0x3416,0x0242,0x0FFF,0x3D42,
	0x0018,0x302E,0x0010,0x422E,0x0016,0xB440,0x670A,0x6C0C,
	0x1D7C,0x0001,0x0016,0x4E75,0x426E,0x0018,0x4E75,0x303A,
	0xFA32,0x6700,0x00B6,0x102E,0x0003,0x6708,0x1D40,0x0017,
	0x422E,0x0003,0x4A6E,0x0018,0x67E2,0x7000,0x102E,0x0017,
	0x4A2E,0x0016,0x6620,0xD16E,0x0010,0x302E,0x0018,0xB06E,
	0x0010,0x6E0A,0x3D6E,0x0018,0x0010,0x426E,0x0018,0x3B6E,
	0x0010,0x0006,0x4E75,0x916E,0x0010,0x302E,0x0018,0xB06E,
	0x0010,0x6DEA,0x3D6E,0x0018,0x0010,0x426E,0x0018,0x3B6E,
	0x0010,0x0006,0x4E75,0x303A,0xF9CA,0x674E,0x102E,0x0003,
	0x6704,0x1D40,0x001A,0x102E,0x001B,0x49FA,0x020E,0xE448,
	0x0240,0x001F,0x7400,0x1434,0x0000,0x102E,0x001A,0x0240,
	0x000F,0xC4C0,0xEC4A,0x302E,0x0010,0x4A2E,0x001B,0x6B04,
	0xD042,0x6002,0x9042,0x3B40,0x0006,0x102E,0x001A,0xE448,
	0x0240,0x003C,0xD12E,0x001B,0x4E75,0x3B6E,0x0010,0x0006,
	0x4E75,0x302E,0x0002,0x0240,0x0FFF,0x67EE,0x102E,0x0002,
	0x0200,0x000F,0x6700,0xFBF4,0x0C00,0x0001,0x6700,0x0090,
	0x0C00,0x0002,0x6700,0x00BA,0x0C00,0x0003,0x6700,0xFF10,
	0x0C00,0x0004,0x6700,0xFF70,0x3B6E,0x0010,0x0006,0x0C00,
	0x000A,0x6702,0x4E75,0x7000,0x102E,0x0003,0xE808,0x672E,
	0xD16E,0x0012,0x0C6E,0x0040,0x0012,0x6B06,0x3D7C,0x0040,
	0x0012,0x3C2E,0x0012,0xCF8F,0x1E86,0xCF8F,0x5246,0x7A00,
	0x1A3A,0xF8F9,0xCCC5,0xE08E,0x3B46,0x0008,0x4E75,0x7000,
	0x102E,0x0003,0x0200,0x000F,0x916E,0x0012,0x6A04,0x426E,
	0x0012,0x3C2E,0x0012,0xCF8F,0x1E86,0xCF8F,0x5246,0x7A00,
	0x1A3A,0xF8C9,0xCCC5,0xE08E,0x3B46,0x0008,0x4E75,0x7000,
	0x102E,0x0003,0x916E,0x0010,0x302E,0x0010,0x0240,0x0FFF,
	0x0C40,0x0071,0x6A0C,0x026E,0xF000,0x0010,0x006E,0x0071,
	0x0010,0x302E,0x0010,0x0240,0x0FFF,0x3B40,0x0006,0x4E75,
	0x4240,0x102E,0x0003,0xD16E,0x0010,0x302E,0x0010,0x0240,
	0x0FFF,0x0C40,0x0358,0x6B0C,0x026E,0xF000,0x0010,0x006E,
	0x0358,0x0010,0x302E,0x0010,0x0240,0x0FFF,0x3B40,0x0006,
	0x4E75,0x102E,0x0002,0x0200,0x000F,0x0C00,0x000E,0x671A,
	0x0C00,0x000D,0x6734,0x0C00,0x000B,0x6736,0x0C00,0x000C,
	0x6750,0x0C00,0x000F,0x6776,0x4E75,0x103A,0xF82E,0x6618,
	0x102E,0x0003,0x0200,0x0001,0xE300,0x0239,0x00FD,0x00BF,
	0xE001,0x8139,0x00BF,0xE001,0x4E75,0x49FA,0x00E1,0x4614,
	0x4E75,0x49FA,0xF8BC,0x102E,0x0003,0xB03A,0x00CE,0x6E06,
	0x197C,0x0001,0xFFFE,0x5300,0x1940,0x081A,0x462C,0x081D,
	0x4E75,0x0C2E,0x0040,0x0003,0x6F06,0x1D7C,0x0040,0x0003,
	0x7C00,0x1C2E,0x0003,0xCF8F,0x1E86,0xCF8F,0x5246,0x7A00,
	0x1A3A,0xF7C9,0xCCC5,0xE08E,0x3B46,0x0008,0x4E75,0x102E,
	0x0003,0x0200,0x001F,0x6710,0x49FA,0xF866,0x422C,0x081B,
	0x1940,0x0816,0x1940,0x0817,0x4E75,0x0018,0x314A,0x6178,
	0x8DA1,0xB4C5,0xD4E0,0xEBF4,0xFAFD,0xFFFD,0xFAF4,0xEBE0,
	0xD4C5,0xB4A1,0x8D78,0x614A,0x3118,0x0358,0x0328,0x02FA,
	0x02D0,0x02A6,0x0280,0x025C,0x023A,0x021A,0x01FC,0x01E0,
	0x01C5,0x01AC,0x0194,0x017D,0x0168,0x0153,0x0140,0x012E,
	0x011D,0x010D,0x00FE,0x00F0,0x00E2,0x00D6,0x00CA,0x00BE,
	0x00B4,0x00AA,0x00A0,0x0097,0x008F,0x0087,0x007F,0x0078,
	0x0071,0x0000,0x0000,0x0606,0x0000,0x0000,0x0000,0x0000,
	0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
	0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
	0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
	0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
	0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
	0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
	0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
	0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
	0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
	0x0001,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
	0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0002,0x0000,
	0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
	0x0000,0x0000,0x0000,0x0000,0x0004,0x0000,0x0000,0x0000,
	0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
	0x0000,0x0000,0x0008,0x0000,0x0000,0x0000
};


void	InitMusic()
{
#asm
InitMusic:
	movem.l	a0-a6/d0-d7,-(a7)
	move.l	_MusicAddr,a1
	jsr		$00E0(a1)
	movem.l	(a7)+,a0-a6/d0-d7
#endasm
}

void	EjectMusic()
{
	PlayMusic = FALSE;
#asm
EjectMusic:
	movem.l	a0-a6/d0-d7,-(a7)
	move.l	_MusicAddr,a1
	jsr		$00AE(a1)
	movem.l	(a7)+,a0-a6/d0-d7
#endasm
}

void	PauseMusic()
{
#asm
PauseMusic:
	move.l	a1,-(a7)
	move.l	_MusicAddr,a1
	tst.w	_PlayMusic
	beq.s	Make_Silence

	move.w	$0044(a1),$007a(a1)		;move NOP
	bra.s	end

Make_Silence:
	move.w	$0046(a1),$007a(a1)		;move RTS
	clr.w	$00dffa8
	clr.w	$00dffb8
	clr.w	$00dffc8
	clr.w	$00dffd8
	move.w	#$000f,$00dff096

end:
	move.l	(a7)+,a1
#endasm
}


/********************************************************************

LoadAndPlayMusic()
Megpróbálja betölteni és elindítani a MusicName nevû zenemodult,
ha sikerül TRUE, ha nem FALSE a visszatérési érték.
A fv. hívásakor beállítja a PlayMusic logikai ,valamint a 
MusicAddr,es a MusicSize globális változók értékét is.
+ a ModulName-t, amely az ujraindításnál tartalmazza az éppen
a memóriában lévõ modul nevét. 

Hivása célszerûen: IsMusicInMemory=LoadAndPlayMusic( MusicName );

*********************************************************************/

BOOL LoadAndPlayMusic( MusicName )
{
	int		i,ActGadget;

	UWORD	*from,*to;
	ULONG	*longto;
	struct	Interrupt	*MusicInt;


/* a 8. ikon OFF állásba */

	Gadget8.GadgetRender=(APTR)&icon[17];

	PlayMusic = FALSE;

/* ha volt már zene a memóriában akkor azt törli */

	if( IsMusicInMemory )
		EjectMusic();

/* megpróbálja betölteni a zene modult */
/* a files.c -ben lévõ LoadFile() rutin A modul hossza+0x09EC bájt helyet */
/* foglal és ennek a területnek a végére tölti a modult. */

	if( !LoadFile( MusicName , T_MUSIC ))
		return( FALSE );

	MusicAddr = FileAddr;
	MusicSize = FileSize;

	from = &server[0];
	to   = (UWORD *)MusicAddr;

/* a lejátszó bemásolása a zenemodul elé */

	for( i=0; i<MUSIC_PLAYER_SIZE/2; i++)
		to[i] = from[i];

/* Interrupt struktúra szükséges elemeinek kitöltése */

	longto = (ULONG *)&MusicAddr[0x0a];			/* int->Node.ln_Name */
	*longto = *longto + (ULONG)MusicAddr;
	longto = (ULONG *)&MusicAddr[0x0e];			/* int->is_Data      */
	*longto = *longto + (ULONG)MusicAddr;
	longto = (ULONG *)&MusicAddr[0x12];			/* int->is_Code      */
	*longto = *longto + (ULONG)MusicAddr;
	longto = (ULONG *)&MusicAddr[0x20];			/* az elsö is_Data elem */
	*longto = (ULONG)MusicSize;

	MusicInt = (struct Interrupt *)MusicAddr;

/* Zene indul */

	AddIntServer( 5,MusicInt );
	InitMusic();

/* a 8. ikon ON helyzetbe állítása */

	PlayMusic = TRUE;
	strcpy( ModulName , MusicName );
	Gadget8.GadgetRender=(APTR)&icon[8];

	return( TRUE );
}
